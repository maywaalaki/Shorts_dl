import os
import asyncio
from telethon import TelegramClient, events
from telethon.tl.types import DocumentAttributeVideo
from yt_dlp import YoutubeDL

API_ID = 29169428
API_HASH = '55742b16a85aac494c7944568b5507e5'
BOT_TOKEN = '8504050677:AAG2VZSPyGt7ItPv9s-mUzNEsT_oPtxusKg'

bot = TelegramClient('video_dl_bot', API_ID, API_HASH).start(bot_token=BOT_TOKEN)

def extract_metadata_from_info(info):
    width = info.get("width")
    height = info.get("height")
    duration = info.get("duration")
    if not width or not height:
        formats = info.get("formats") or []
        for f in formats:
            if f.get("width") and f.get("height"):
                width = f.get("width")
                height = f.get("height")
                break
    return width, height, duration

@bot.on(events.NewMessage(pattern='/start'))
async def start(event):
    await event.reply("**Haye Laki!** Iisoo dir linkiga muuqaalka aad rabto inaan kuu soo dejiyo.")

@bot.on(events.NewMessage)
async def handler(event):
    url = event.text
    if not url.startswith(("http://", "https://")):
        return

    msg = await event.reply("‚è≥ **Waan ku guda jiraa, fadlan sug...**")

    ydl_opts = {
        'format': 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best',
        'outtmpl': 'video_%(id)s.%(ext)s',
        'quiet': True,
    }

    try:
        with YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=True)
            filename = ydl.prepare_filename(info)
            title = info.get('title', 'Video')
            width, height, duration = extract_metadata_from_info(info)

            caption = f"üé¨ **{title}**"

            attr = []
            if width and height and duration:
                attr.append(DocumentAttributeVideo(
                    duration=int(duration),
                    w=int(width),
                    h=int(height),
                    supports_streaming=True
                ))

            await bot.send_file(
                event.chat_id, 
                filename, 
                caption=caption,
                supports_streaming=True,
                attributes=attr
            )

        if os.path.exists(filename):
            os.remove(filename)
        await msg.delete()

    except Exception as e:
        await msg.edit(f"‚ùå Khalad ayaa dhacay: {str(e)}")

bot.run_until_disconnected()
