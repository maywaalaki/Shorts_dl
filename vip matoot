import os
import uuid
import uvicorn
import requests
from fastapi import FastAPI, BackgroundTasks, HTTPException
from fastapi.staticfiles import StaticFiles
from yt_dlp import YoutubeDL

proxy_url = "http://qwxjtcpo:997e5t61cazs@31.59.20.176:6754"

os.environ['http_proxy'] = proxy_url
os.environ['https_proxy'] = proxy_url
os.environ['HTTP_PROXY'] = proxy_url
os.environ['HTTPS_PROXY'] = proxy_url

app = FastAPI()

if not os.path.exists("static"):
    os.makedirs("static")

app.mount("/static", StaticFiles(directory="static"), name="static")

def process_video_task(url: str, chat_id: int, webhook_url: str):
    file_id = str(uuid.uuid4())[:8]
    filename = f"video_{file_id}.mp4"
    filepath = os.path.join("static", filename)
    
    ydl_opts = {
        "format": "best[ext=mp4]",
        "outtmpl": filepath,
        "noplaylist": True,
        "quiet": True,
        "cookiefile": "cookies.txt" if os.path.exists("cookies.txt") else None,
        "nocheckcertificate": True,
        "proxy": proxy_url,
        "socket_timeout": 60
    }
    
    try:
        with YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=True)
            
            space_id = os.environ.get('SPACE_ID')
            if space_id:
                parts = space_id.split('/')
                u_name = parts[0]
                s_name = parts[1].replace('_', '-')
                direct_hf_url = f"https://{u_name}-{s_name}.hf.space/static/{filename}"
            else:
                direct_hf_url = f"https://lakiup3-ytdlsr.hf.space/static/{filename}"
            
            payload = {
                "success": True,
                "video_url": direct_hf_url,
                "title": info.get("title", "No Title"),
                "chat_id": chat_id
            }
            
            requests.post(webhook_url, json=payload, timeout=30, proxies={"http": "", "https": ""})
                
    except Exception as e:
        if webhook_url:
            requests.post(webhook_url, json={"success": False, "error": str(e), "chat_id": chat_id}, timeout=30, proxies={"http": "", "https": ""})

@app.get("/")
def home():
    return {"status": "HF Engine is Active", "user": "Laki"}

@app.post("/download")
async def download_video(data: dict, background_tasks: BackgroundTasks):
    video_url = data.get("url")
    chat_id = data.get("chat_id")
    webhook = data.get("webhook")
    
    if not video_url or not chat_id:
        raise HTTPException(status_code=400, detail="URL and chat_id are required")
    
    background_tasks.add_task(process_video_task, video_url, chat_id, webhook)
    
    return {"success": True, "message": "Processing started"}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=7860)
