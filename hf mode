import os
import asyncio
import threading
import socks
import gradio as gr
from telethon import TelegramClient, events
from telethon.tl.types import DocumentAttributeVideo
from yt_dlp import YoutubeDL

API_ID = 29169428
API_HASH = '55742b16a85aac494c7944568b5507e5'
BOT_TOKEN = '7757263177:AAGEtvMa8RzecP90JE2ZYdDGbpXqTzvn6OE'

PROXY = {
    'proxy_type': socks.SOCKS5,
    'addr': '85.209.231.64',
    'port': 1080
}

bot = TelegramClient('video_dl_bot', API_ID, API_HASH, proxy=PROXY)

def extract_metadata_from_info(info):
    width = info.get("width")
    height = info.get("height")
    duration = info.get("duration")
    if not width or not height:
        formats = info.get("formats") or []
        for f in formats:
            if f.get("width") and f.get("height"):
                width = f.get("width")
                height = f.get("height")
                break
    return width, height, duration

@bot.on(events.NewMessage(pattern='/start'))
async def start(event):
    await event.reply("**Haye Laki!** Iisoo dir linkiga Muuqaal TikTok, Instagram ama Pinterest si aan kuugu soo dejiyo.")

@bot.on(events.NewMessage)
async def handler(event):
    if event.text.startswith('/start'):
        return
        
    url = event.text
    if not url.startswith(("http://", "https://")):
        return

    allowed_domains = ["tiktok.com", "instagram.com", "pinterest.com", "pin.it"]
    if not any(domain in url for domain in allowed_domains):
        await event.reply("‚ùå Bot-kani wuxuu u gaar yahay kaliya TikTok, Instagram, iyo Pinterest.")
        return

    msg = await event.reply("‚è≥ **Waan ku guda jiraa, fadlan sug...**")

    ydl_opts = {
        'format': 'best',
        'outtmpl': 'video_%(id)s.%(ext)s',
        'writethumbnail': True,
        'quiet': True,
    }

    if "pinterest.com" in url or "pin.it" in url:
        ydl_opts.update({
            'format': 'bestvideo+bestaudio/best',
            'check_formats': True,
            'ignoreerrors': True
        })

    try:
        with YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=True)
            filename = ydl.prepare_filename(info)
            
            caption = info.get('title', 'Video')
            if info.get('description'):
                caption = info.get('description')[:1024]

            width, height, duration = extract_metadata_from_info(info)
            
            thumb_path = None
            base_name = os.path.splitext(filename)[0]
            for ext in ['jpg', 'png', 'webp', 'jpeg']:
                potential_thumb = f"{base_name}.{ext}"
                if os.path.exists(potential_thumb):
                    thumb_path = potential_thumb
                    break

            attr = []
            if width and height and duration:
                attr.append(DocumentAttributeVideo(
                    duration=int(duration),
                    w=int(width),
                    h=int(height),
                    supports_streaming=True
                ))

            await bot.send_file(
                event.chat_id, 
                filename, 
                caption=caption,
                thumb=thumb_path,
                supports_streaming=True,
                attributes=attr,
                reply_to=event.id
            )

        if os.path.exists(filename):
            os.remove(filename)
        if thumb_path and os.path.exists(thumb_path):
            os.remove(thumb_path)
            
        await msg.delete()

    except Exception as e:
        await msg.edit(f"‚ùå Khalad ayaa dhacay: Linkigaas lama soo dejin karo xilligan.")

def run_bot():
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    bot.start(bot_token=BOT_TOKEN)
    bot.run_until_disconnected()

def fake_api(input_text):
    return f"Processing: {input_text} ... Status: Bot is Active üöÄ"

if __name__ == '__main__':
    threading.Thread(target=run_bot, daemon=True).start()
    
    interface = gr.Interface(
        fn=fake_api,
        inputs=gr.Textbox(label="System Status Check", placeholder="Geli qoraal..."),
        outputs=gr.Textbox(label="Result"),
        title="AI Video Processing Engine",
        description="Kani waa interface-ka maamulka nidaamka. Bot-ka Telegram-ka wuxuu ku dhex ordayaa gadaal."
    )
    
    interface.launch(server_name="0.0.0.0", server_port=7860)
